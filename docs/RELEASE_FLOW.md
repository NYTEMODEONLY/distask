# Rapid Release Flow Guide

This guide explains how to use DisTask's rapid release system for score-based, validated releases.

## Overview

The rapid release flow provides a "wake up and ship" process that:
- Uses score-based decisions from the feature queue
- Validates everything before commits
- Automates versioning, changelog, and GitHub releases
- Integrates seamlessly with the existing PR-first workflow

## Prerequisites

1. **Feature Queue Generated**: Run `feature_agent.py` to generate `automation/feature_queue.json`
2. **Environment Configured**: Set `RELEASE_THRESHOLD` in `.env` (default: 80.0)
3. **GitHub Credentials**: `GITHUB_TOKEN`, `REPO_OWNER`, `REPO_NAME` in `.env` (for releases)
4. **Database Access**: `DATABASE_URL` in `.env` (optional, for full feature details)

## Quick Start

### 1. Suggest Release Batch

See what features are ready for release:

```bash
python scripts/release_helper.py --suggest --threshold 80
```

Output shows:
- Feature IDs and titles
- Scores (priority + ease + votes - penalties)
- Rationale for selection
- Number of features suggested

### 2. Validate Everything

Before any release, validate code quality:

```bash
python scripts/release_helper.py --validate
```

This checks:
- Code formatting (black)
- Code style (flake8)
- Type hints (mypy, non-blocking)
- Tests (pytest, if tests exist)
- Git state (clean working tree)
- Feature queue consistency
- Database schema compatibility

### 3. Full Release Cycle (Dry Run)

Simulate a complete release without making changes:

```bash
python scripts/release_helper.py --full-cycle --dry-run --threshold 80
```

This shows what would happen:
- Features selected
- Version bump
- Changelog generation
- Git tag creation
- GitHub release creation

### 4. Execute Release

After validation passes and dry-run looks good:

```bash
python scripts/release_helper.py --full-cycle --yes --auto-select --threshold 80
```

This:
- Selects top-scoring features automatically
- Skips confirmation prompts (use `--yes`)
- Validates before proceeding
- Bumps version
- Creates changelog
- Creates git tag
- Creates GitHub release
- Marks features as shipped

## Detailed Workflow

### Step 1: Review Feature Queue

The release helper reads from `automation/feature_queue.json`, which is generated by `feature_agent.py`.

Ensure the queue is up to date:

```bash
python scripts/feature_agent.py
```

### Step 2: Configure Threshold

Set `RELEASE_THRESHOLD` in `.env`:

```env
RELEASE_THRESHOLD=80.0
```

Or pass via CLI:

```bash
python scripts/release_helper.py --suggest --threshold 85
```

### Step 3: Select Features

The helper selects features where:
- `score >= threshold`
- `status` is `pending` or `in_progress`
- Not marked as duplicate
- Sorted by score (highest first)
- Limited to `--max-items` (default: 5)

### Step 4: Validate

**Critical Checks** (must pass):
- Code formatting (black)
- Code style (flake8)
- Tests (if tests exist)
- Git state (clean working tree)
- Feature queue consistency

**Non-Blocking Checks** (warnings only):
- Type checking (mypy)
- Database schema (if DB unavailable)
- FR marker duplicates

### Step 5: Version Bump

Version is stored in `VERSION` file and follows semantic versioning:
- **Patch** (`--bump-type patch`): Bug fixes, small changes
- **Minor** (`--bump-type minor`): New features (default)
- **Major** (`--bump-type major`): Breaking changes

### Step 6: Generate Changelog

Changelog entry includes:
- Version and date
- List of features (FR-XXX: Title)
- Feature descriptions
- Link to full changelog diff

Appended to `CHANGELOG.md` at the top.

### Step 7: Create Git Tag

Creates annotated tag: `v1.2.3`

```bash
git tag -a v1.2.3 -m "Release 1.2.3"
```

### Step 8: Create GitHub Release

If GitHub credentials are configured:
- Creates release via API
- Uses changelog as release notes
- Tags with version
- Includes feature request IDs

### Step 9: Mark Features Shipped

Features are logged as shipped (doesn't mark as `completed` - that's for implementation).

## Integration with PR-First Workflow

The release helper integrates with the existing PR-first workflow:

### Before Release

1. **Implement Features**: Use PR-first workflow (see `docs/FEATURE_REQUEST_WORKFLOW.md`)
   - Create PR on `feature/XXX-slug` branch
   - Get code review
   - Implement with FR markers
   - Merge PR

2. **Feature Agent Runs**: Marks features as `completed` when PRs merge

3. **Release Helper**: Selects `pending` features for next release batch

### Release Process

```bash
# 1. Suggest batch
python scripts/release_helper.py --suggest

# 2. Implement features (if not already done)
# ... create PRs, get review, merge ...

# 3. Validate
python scripts/release_helper.py --validate

# 4. Release
python scripts/release_helper.py --full-cycle --yes --auto-select
```

### After Release

1. **Services Restart**: Manually restart if needed:
   ```bash
   sudo systemctl restart distask.service distask-web.service
   ```

2. **Verify**: Check GitHub release and changelog

3. **Next Cycle**: Feature agent runs nightly, updates queue

## CLI Reference

### `--suggest`

Show release batch suggestion:

```bash
python scripts/release_helper.py --suggest [--threshold 80] [--max-items 5]
```

**Options**:
- `--threshold`: Score threshold (default: from .env or 80.0)
- `--max-items`: Maximum features to suggest (default: 5)

### `--validate`

Run all validation checks:

```bash
python scripts/release_helper.py --validate [--db-url URL] [--skip-tests]
```

**Options**:
- `--db-url`: Database URL for schema validation
- `--skip-tests`: Skip test execution

### `--full-cycle`

Execute complete release cycle:

```bash
python scripts/release_helper.py --full-cycle [OPTIONS]
```

**Options**:
- `--threshold`: Score threshold (default: 80.0)
- `--max-items`: Maximum features (default: 5)
- `--dry-run`: Simulate without changes
- `--auto-select`: Auto-select top features
- `--yes`: Skip confirmation prompts
- `--bump-type`: Version bump type (`major`/`minor`/`patch`, default: `minor`)
- `--db-url`: Database URL
- `--skip-tests`: Skip tests

## Examples

### Example 1: Quick Release

```bash
# Suggest features
python scripts/release_helper.py --suggest --threshold 80

# Validate
python scripts/release_helper.py --validate

# Release (with confirmation)
python scripts/release_helper.py --full-cycle --threshold 80
```

### Example 2: Automated Release

```bash
# Full cycle with auto-select and no prompts
python scripts/release_helper.py --full-cycle \
  --yes \
  --auto-select \
  --threshold 85 \
  --max-items 3 \
  --bump-type minor
```

### Example 3: Dry Run First

```bash
# Always dry-run first
python scripts/release_helper.py --full-cycle --dry-run --threshold 80

# Review output, then execute
python scripts/release_helper.py --full-cycle --yes --auto-select --threshold 80
```

### Example 4: Custom Validation

```bash
# Validate with custom DB URL
python scripts/release_helper.py --validate --db-url postgresql://user:pass@host/db

# Skip tests during validation
python scripts/release_helper.py --validate --skip-tests
```

## Troubleshooting

### No Features Suggested

**Problem**: `--suggest` returns no candidates

**Solutions**:
1. Lower threshold: `--threshold 50`
2. Run feature_agent: `python scripts/feature_agent.py`
3. Check queue: `cat automation/feature_queue.json`

### Validation Fails

**Problem**: `--validate` reports failures

**Solutions**:
1. Fix formatting: `black .`
2. Fix style: Address flake8 issues
3. Fix tests: Run `pytest` separately
4. Clean git: `git status` and commit/stash changes

### GitHub Release Fails

**Problem**: Release creation fails

**Solutions**:
1. Check credentials: Verify `GITHUB_TOKEN` in `.env`
2. Check permissions: Token needs `repo` scope
3. Check network: API might be rate-limited
4. Manual release: Create release on GitHub UI

### Version File Missing

**Problem**: Version file not found

**Solutions**:
1. Create manually: `echo "1.0.0" > VERSION`
2. Use git tag: Helper will read from latest tag
3. Default: Starts at `1.0.0` if neither exists

### Database Connection Fails

**Problem**: Schema validation fails

**Solutions**:
1. Skip DB validation: Don't provide `--db-url`
2. Check connection: `psql $DATABASE_URL -c "SELECT 1"`
3. Non-blocking: Schema check warnings don't block release

## Best Practices

1. **Always Dry-Run First**: Test with `--dry-run` before executing
2. **Validate Before Release**: Run `--validate` separately first
3. **Review Suggestions**: Check `--suggest` output before releasing
4. **Keep Queue Updated**: Run `feature_agent.py` regularly
5. **Use PR-First**: Implement features via PRs before releasing
6. **Test Locally**: Test release helper in dev environment first
7. **Monitor Services**: Check service health after release

## AI-Assisted Implementation

Use `docs/release_prompt_templates.md` for AI-assisted feature implementation:

1. **Get Feature Details**: From `--suggest` output
2. **Use Template**: Copy template from `release_prompt_templates.md`
3. **Fill Placeholders**: Replace `[XXX]` with actual values
4. **Generate Code**: Use AI tool with template
5. **Review**: Use code review template
6. **Validate**: Run `--validate` before committing

## Related Documentation

- `docs/FEATURE_REQUEST_WORKFLOW.md`: PR-first implementation workflow
- `docs/release_prompt_templates.md`: AI/IDE prompt templates
- `README.md`: General project overview
- `CLAUDE.md`: Development guidelines

